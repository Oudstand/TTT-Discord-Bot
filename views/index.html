<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <title>TTT Dashboard</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
        <script>
            window.onload = () => {
                lucide.createIcons();
            };
        </script>
    </head>
    <body class="bg-slate-900 text-white min-h-screen font-sans">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">TTT Dashboard</h1>
                <span id="status" class="text-sm text-gray-300">üîÑ Lade...</span>
            </div>

            <form id="bindingForm" class="bg-slate-800 p-4 rounded-2xl shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input name="name" placeholder="Name" class="bg-slate-700 text-white p-2 rounded-lg" required />
                    <input name="steamId" placeholder="SteamID64" class="bg-slate-700 text-white p-2 rounded-lg" required />
                    <input name="discordId" placeholder="Discord-ID" class="bg-slate-700 text-white p-2 rounded-lg" required />
                </div>
                <button type="submit" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md">
                    <i data-lucide="save" class="inline w-4 h-4 mr-1"></i> Speichern
                </button>
            </form>

            <div class="mb-6">
                <input id="search" placeholder="üîç Suche..." class="w-full bg-slate-800 p-2 rounded-lg text-white" />
            </div>

            <div id="bindingsList" class="space-y-2 mb-8"></div>

            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-2">üéôÔ∏è Spieler im Voice</h2>
                <div id="voiceList" class="space-y-2 text-sm"></div>
            </div>

            <footer class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800 py-4">
                <button
                    class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-2 mx-auto"
                    onclick="endRound()"
                >
                    <i class="w-5 h-5" data-lucide="stop-circle"></i> Runde beenden
                </button>
            </footer>
        </div>

        <script>
            let currentEdit = null;

            async function loadStatus() {
                const res = await fetch('/api/status');
                const data = await res.json();
                document.getElementById('status').textContent = `üü¢ Verbunden als: ${data.tag}`;
            }

            async function loadBindings() {
                const res = await fetch('/api/bindings');
                const data = await res.json();
                const list = document.getElementById('bindingsList');
                const search = document.getElementById('search').value.toLowerCase();
                list.innerHTML = '';
                data
                    .filter(info => info.name.toLowerCase().includes(search) || info.steamId.includes(search))
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(info => {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center bg-slate-800 p-3 rounded-xl shadow-md';
                            div.innerHTML = `
                              <span>
                                ${info.name} ‚Äì
                                Steam: <a href="https://steamcommunity.com/profiles/${info.steamId}" target="_blank" class="text-blue-400 underline">${info.steamId}</a> ‚Äì
                                Discord: <a href="https://discordlookup.com/user/${info.discordId}" target="_blank" class="text-blue-400 underline">${info.discordId}</a>
                              </span>

                              <div class="flex gap-2">
                                <button onclick="editBinding('${info.steamId}')" class="text-blue-400 hover:text-blue-200" title="Bearbeiten">
                                  <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteBinding('${info.steamId}')" class="text-red-400 hover:text-red-200" title="L√∂schen">
                                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                              </div>`;
                            list.appendChild(div);
                            lucide.createIcons();
                    });
            }

            async function loadVoiceList() {
                const res = await fetch('/api/voice');
                const data = await res.json();
                const list = document.getElementById('voiceList');
                list.innerHTML = '';
                data.forEach((p) => {
                    const div = document.createElement('div');
                    const color = p.muted ? 'bg-red-800' : 'bg-green-800';
                    const button = p.muted
                        ? `<button onclick="unmute('${p.discordId}')" class="text-white hover:text-white/80" title="Entmuten">
                          <i data-lucide="mic" class="w-5 h-5"></i></button>`
                        : `<button onclick="mute('${p.discordId}')" class="text-white hover:text-white/80" title="Muten">
                          <i data-lucide="mic-off" class="w-5 h-5"></i></button>`;
                    div.className = `flex items-center justify-between ${color} p-3 rounded-xl shadow-md`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                          <img src="${p.avatarUrl}" class="w-10 h-10 rounded-full ring-2 ring-white/20" />
                          <span>${p.name}</span>
                        </div>
                        ${button}`;
                    list.appendChild(div);
                    lucide.createIcons();
                });
            }

            async function mute(discordId) {
                await fetch('/api/mute/' + discordId, {method: 'POST'});
                loadVoiceList();
            }

            async function unmute(discordId) {
                await fetch('/api/unmute/' + discordId, {method: 'POST'});
                loadVoiceList();
            }

            async function endRound() {
                await fetch('/api/unmuteAll', {method: 'POST'});
                loadVoiceList();
            }

            async function deleteBinding(steamId) {
                if (confirm('Wirklich l√∂schen?')) {
                    await fetch('/api/bindings/' + steamId, {method: 'DELETE'});
                    loadBindings();
                }
            }

            function editBinding(steamId) {
                fetch('/api/bindings/' + steamId)
                    .then((res) => res.json())
                    .then((data) => {
                        document.querySelector('[name="name"]').value = data.name;
                        document.querySelector('[name="steamId"]').value = steamId;
                        document.querySelector('[name="discordId"]').value = data.discordId;
                        currentEdit = steamId;
                    });
            }

            document.getElementById('bindingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = new FormData(e.target);
                const payload = Object.fromEntries(form.entries());
                await fetch('/api/bindings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                e.target.reset();
                currentEdit = null;
                loadBindings();
            });

            document.getElementById('search').addEventListener('input', loadBindings);

            loadStatus();
            loadBindings();
            loadVoiceList();
            setInterval(loadVoiceList, 5000);
        </script>
    </body>
</html>
